<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.5.xsd"
        logicalFilePath="database/changelog.xml">

    <changeSet id="001-create-tables.xml" author="drugalevmaxim">
        <createSequence sequenceName="users_id_seq"/>
        <createTable tableName="users">
            <column name="id" type="BIGINT" defaultValueComputed="nextval('users_id_seq')">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="username" type="varchar(255)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="password" type="varchar(255)"/>
        </createTable>
        <createSequence sequenceName="privileges_id_seq"/>
        <createTable tableName="privileges">
            <column name="id" type="BIGINT" defaultValueComputed="nextval('privileges_id_seq')">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="varchar(255)">
                <constraints nullable="false" unique="true"/>
            </column>
        </createTable>
        <createSequence sequenceName="roles_id_seq"/>
        <createTable tableName="roles">
            <column name="id" type="BIGINT" defaultValueComputed="nextval('roles_id_seq')">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="varchar(255)">
                <constraints nullable="false" unique="true"/>
            </column>
        </createTable>
        <createTable tableName="role_privileges">
            <column name="role_id" type="BIGINT">
                <constraints nullable="false" foreignKeyName="role_privileges_role_id_fkey" deleteCascade="true" references="roles(id)"/>
            </column>
            <column name="privilege_id" type="BIGINT">
                <constraints nullable="false" foreignKeyName="role_privileges_privilege_id_fkey" deleteCascade="true" references="privileges(id)"/>
            </column>
        </createTable>
        <createTable tableName="user_roles">
            <column name="user_id" type="BIGINT">
                <constraints nullable="false" foreignKeyName="user_roles_usr_id_fkey" deleteCascade="true" references="users(id)"/>
            </column>
            <column name="role_id" type="BIGINT">
                <constraints nullable="false" foreignKeyName="user_roles_role_id_fkey" deleteCascade="true" references="roles(id)"/>
            </column>
        </createTable>

        <createSequence sequenceName="trainings_type_id_seq"/>
        <createTable tableName="training_types">
            <column name="id" type="BIGINT" defaultValueComputed="nextval('trainings_type_id_seq')">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="varchar(255)">
                <constraints unique="true" nullable="false"/>
            </column>
        </createTable>

        <createSequence sequenceName="trainings_id_seq"/>
        <createTable tableName="trainings">
            <column name="id" type="BIGINT" defaultValueComputed="nextval('trainings_id_seq')">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="performer" type="BIGINT">
                <constraints nullable="false" foreignKeyName="trainings_performer_fkey" deleteCascade="true" references="users(id)"/>
            </column>
            <column name="date" type="date">
                <constraints nullable="false"/>
            </column>
            <column name="training_type" type="BIGINT">
                <constraints nullable="false" foreignKeyName="trainings_training_type_fkey" deleteCascade="true" references="training_types(id)"/>
            </column>
            <column name="duration" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="burned_calories" type="BIGINT">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addUniqueConstraint constraintName="unique_training_constant" tableName="trainings" columnNames="performer, date, training_type"/>

        <createTable tableName="training_data">
            <column name="training" type="BIGINT">
                <constraints  nullable="false" foreignKeyName="trainings_training_data_fkey" deleteCascade="true" references="trainings(id)"/>
            </column>
            <column name="name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="value" type="bigint">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addUniqueConstraint constraintName="unique_training_data_constant" tableName="training_data" columnNames="training, name"/>

        <createTable tableName="audit">
            <column name="user" type="BIGINT">
                <constraints nullable="false" foreignKeyName="audit_user_fkey" deleteCascade="true" references="users(id)"/>
            </column>
            <column name="time" type="timestamp" defaultValueComputed="now()">
                <constraints nullable="false"/>
            </column>
            <column name="action" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

</databaseChangeLog>